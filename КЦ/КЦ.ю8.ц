взяти визначення ./КЦ;

зовнішня дія __КЦ__прочитати_файл(виділяч: адреса<біб::Виділяч>, шлях: адреса<КЦ::Шлях>, вихід: адреса<КЦ::Байти>, вихід_успіху: адреса<логічне>);
зовнішня дія __КЦ__перевірити_чи_шлях_існує(виділяч: адреса<біб::Виділяч>, шлях: адреса<КЦ::Шлях>): логічне;
зовнішня дія __КЦ__отримати_директорію_шляху_до_файлу(виділяч: адреса<біб::Виділяч>, вхід: адреса<КЦ::Шлях>, вихід: адреса<КЦ::Шлях>): логічне;
зовнішня дія __КЦ__отримати_поточну_директорію_процесу(виділяч: адреса<біб::Виділяч>, вихід: адреса<КЦ::Шлях>): логічне;
зовнішня дія __КЦ__отримати_абсолютний_шлях(виділяч: адреса<біб::Виділяч>, вхід: адреса<КЦ::Шлях>, вихід: адреса<КЦ::Шлях>): логічне;

секція КЦ {
  зовнішня дія перекодувати_ю8_в_т8_з_місцезнаходженнями(компілятор: адреса<Компілятор>, значення: ю8, вихід: адреса<т8>, вихід_місцезнаходжень: адреса<біб::МісцезнаходженняПерекодованого>): логічне {
    змінна позиція_помилки: позитивне = 0;

    вернути біб::перекодувати_ю8_в_т8(
      компілятор.виділяч,
      значення,
      так,
      ні,
      вихід,
      вихід_місцезнаходжень,
      позиція_помилки::адреса
    );
  }

  зовнішня дія отримати_т8_з_ю8(компілятор: адреса<Компілятор>, значення: ю8): т8 {
    змінна результат = т8 { 0, пусто };

    змінна позиція_помилки: позитивне = 0;

    якщо біб::перекодувати_ю8_в_т8(компілятор.виділяч, значення, так, ні, результат::адреса, пусто, позиція_помилки::адреса) == ні {
      // потім: обробити помилку
    }

    вернути результат;
  }

  зовнішня дія отримати_ю8_з_т8(компілятор: адреса<Компілятор>, значення: т8): ю8 {
    змінна результат = ю8 { 0, пусто };

    змінна позиція_помилки: позитивне = 0;

    якщо біб::перекодувати_т8_в_ю8(компілятор.виділяч, значення, ні, результат::адреса, пусто, позиція_помилки::адреса) == ні {
      // потім: обробити помилку
    }

    вернути результат;
  }

  зовнішня дія прочитати_файл(компілятор: адреса<Компілятор>, шлях: Шлях, вихід: адреса<Байти>): логічне {
    змінна успіх = ні;
    __КЦ__прочитати_файл(компілятор.виділяч, шлях::адреса, вихід, успіх::адреса);
    вернути успіх;
  }

  зовнішня дія скомпілювати_текст_коду(компілятор: адреса<Компілятор>, текст_коду: адреса<ТекстКоду>, вихід_помилки: адреса<адреса<Помилка>>): логічне {
    змінна розбирач = КЦ::розбирач::створити(компілятор.виділяч);

    змінна успіх_розбору = ні;

    змінна розібраний_текст = створити_розібраний_текст(компілятор);
    розібраний_текст.текст_коду = текст_коду;
    розібраний_текст.розбирач = розбирач;

    покласти_взятий_файл(компілятор.взяті_файли, текст_коду.шлях, розібраний_текст);

    змінна помилка_розбору_на_слова: КЦ::розбирач::ПомилкаРозборуНаСлова;
    змінна помилка_розбору_на_сполуки: КЦ::розбирач::ПомилкаРозборуНаСполуки;

    успіх_розбору = КЦ::розбирач::розібрати_на_слова(
      розбирач,
      т8 { текст_коду.значення.розмір, текст_коду.значення.дані },
      розібраний_текст.слова::адреса,
      помилка_розбору_на_слова::адреса
    );
    якщо успіх_розбору == ні {
      змінна позиція_в_тексті = помилка_розбору_на_слова.позиція.позиція_в_тексті;
      змінна рядок = помилка_розбору_на_слова.позиція.рядок;
      змінна стовпець = помилка_розбору_на_слова.позиція.стовпець;

      вихід_помилки::вміст = створити_помилку(
        компілятор,
        "Неочікуваний символ.",
        створити_місцезнаходження_помилки(компілятор, текст_коду, позиція_в_тексті, рядок, стовпець)
      );

      вернути ні;
    }

//    біб::надрукувати_ю8(ю8 { текст_коду.шлях.розмір, текст_коду.шлях.дані });
//    біб::надрукувати_ю8(ю8"--- слова ---");
//    КЦ::розбирач::надрукувати_слова(розбирач, текст_коду.значення, розібраний_текст.слова);
//    біб::надрукувати_ю8(ю8"--- кінець слів ---");

    успіх_розбору = КЦ::розбирач::розібрати_слова_на_сполуки(розбирач, розібраний_текст.слова, розібраний_текст.сполуки::адреса, помилка_розбору_на_сполуки::адреса);
    якщо успіх_розбору == ні {
      змінна позиція_в_тексті = розібраний_текст.слова.дані[помилка_розбору_на_сполуки.позиція_слова].позиція_початку.позиція_в_тексті;
      змінна рядок = розібраний_текст.слова.дані[помилка_розбору_на_сполуки.позиція_слова].позиція_початку.рядок;
      змінна стовпець = розібраний_текст.слова.дані[помилка_розбору_на_сполуки.позиція_слова].позиція_початку.стовпець;

      вихід_помилки::вміст = створити_помилку(
        компілятор,
        "Неочікуване слово.",
        створити_місцезнаходження_помилки(компілятор, текст_коду, позиція_в_тексті, рядок, стовпець)
      );

      вернути ні;
    }

//    біб::надрукувати_ю8(ю8 { текст_коду.шлях.розмір, текст_коду.шлях.дані });
//    біб::надрукувати_ю8(ю8"--- сполуки ---");
//    КЦ::розбирач::надрукувати_сполуки(розбирач, текст_коду.значення, розібраний_текст.слова, розібраний_текст.сполуки, 0);
//    біб::надрукувати_ю8(ю8"--- кінець сполук ---");

    змінна результат_компіляції_тіла = скомпілювати_тіло(
      компілятор,
      Контекст {
        розібраний_текст = розібраний_текст,
        середовище = компілятор.глобальне_середовище,
        кк_дії = пусто
      },
      розібраний_текст.сполуки,
      КЦ::розбирач::Місцезнаходження { 0, 0 }
    );

    якщо результат_компіляції_тіла.помилка != пусто {
      вихід_помилки::вміст = результат_компіляції_тіла.помилка;
      вернути ні;
    }

    // ...

    вернути так;
  }

  зовнішня дія взяти_файл_ю8(компілятор: адреса<Компілятор>, шлях: Шлях, вихід_помилки: адреса<адреса<Помилка>>): логічне {
    змінна взятий_файл: адреса<РозібранийТекст> = пусто;
    якщо знайти_взятий_файл(компілятор.взяті_файли, шлях, взятий_файл::адреса) {
      вернути так;
    }

    змінна код = Байти { 0, пусто };

    якщо прочитати_файл(компілятор, шлях, код::адреса) == ні {
      вихід_помилки::вміст = створити_помилку(компілятор, "Не вдалось прочитати файл.", пусто);

      вернути ні;
    }

    змінна текст_коду = створити_текст_коду(компілятор);

    текст_коду.шлях = клонувати_шлях(компілятор, шлях);
    текст_коду.значення = т8 { 0, пусто };
    текст_коду.кодування_оригінального_значення = КодуванняЮ8;
    текст_коду.оригінальне_значення = код;
    текст_коду.місцезнаходження_оригінального_значення = біб::МісцезнаходженняПерекодованого { 0, пусто, 0 };

    якщо перекодувати_ю8_в_т8_з_місцезнаходженнями(компілятор, ю8 { код.розмір, код.дані }, текст_коду.значення::адреса, текст_коду.місцезнаходження_оригінального_значення::адреса) == ні {
      вернути ні;
    }

    вернути скомпілювати_текст_коду(компілятор, текст_коду, вихід_помилки);
  }

  зовнішня дія перевірити_чи_шлях_існує(компілятор: адреса<Компілятор>, шлях: Шлях): логічне {
    вернути __КЦ__перевірити_чи_шлях_існує(компілятор.виділяч, шлях::адреса);
  }

  зовнішня дія отримати_директорію_шляху_до_файлу(компілятор: адреса<Компілятор>, вхід: Шлях, вихід: адреса<Шлях>): логічне {
    вернути __КЦ__отримати_директорію_шляху_до_файлу(компілятор.виділяч, вхід::адреса, вихід);
  }

  зовнішня дія отримати_поточну_директорію_процесу(компілятор: адреса<Компілятор>, вихід: адреса<Шлях>): логічне {
    вернути __КЦ__отримати_поточну_директорію_процесу(компілятор.виділяч, вихід);
  }

  зовнішня дія отримати_абсолютний_шлях(компілятор: адреса<Компілятор>, вхід: Шлях, вихід: адреса<Шлях>): логічне {
    вернути __КЦ__отримати_абсолютний_шлях(компілятор.виділяч, вхід::адреса, вихід);
  }

  синонім СИМВОЛ_ПЛЮС = КД::символи::Хрестик;
  синонім СИМВОЛ_МІНУС = КД::символи::Риска;
  синонім СИМВОЛ_0 = КД::символи::Нуль;
  синонім СИМВОЛ_1 = КД::символи::Один;
  синонім СИМВОЛ_2 = КД::символи::Два;
  синонім СИМВОЛ_3 = КД::символи::Три;
  синонім СИМВОЛ_4 = КД::символи::Чотири;
  синонім СИМВОЛ_5 = КД::символи::Пʼять;
  синонім СИМВОЛ_6 = КД::символи::Шість;
  синонім СИМВОЛ_7 = КД::символи::Сім;
  синонім СИМВОЛ_8 = КД::символи::Вісім;
  синонім СИМВОЛ_9 = КД::символи::Девʼять;
  синонім СИМВОЛ_КРАПКА = КД::символи::Крапка;

  зовнішня дія спробувати_розібрати_ціле_число(компілятор: адреса<Компілятор>, значення: т8, вихід: адреса<ц64>, вихід_помилки: адреса<т8>, вихід_позиції_помилки: адреса<позитивне>): логічне {
    змінна вихідне: ціле = 0;
    змінна знак: ц8 = 1;
    змінна п: позитивне = 0;

    якщо п < значення.розмір {
      якщо значення.дані[п] == СИМВОЛ_МІНУС {
        знак = ц8(0) - 1;
        п += 1;
      } інакше якщо значення.дані[п] == СИМВОЛ_ПЛЮС {
        п += 1;
      }
    }

    поки п < значення.розмір {
      змінна с = значення.дані[п];

      якщо с == СИМВОЛ_0 {
      } інакше якщо с == СИМВОЛ_1 {
      } інакше якщо с == СИМВОЛ_2 {
      } інакше якщо с == СИМВОЛ_3 {
      } інакше якщо с == СИМВОЛ_4 {
      } інакше якщо с == СИМВОЛ_5 {
      } інакше якщо с == СИМВОЛ_6 {
      } інакше якщо с == СИМВОЛ_7 {
      } інакше якщо с == СИМВОЛ_8 {
      } інакше якщо с == СИМВОЛ_9 {
      } інакше {
        стрибнути успіх;
      }

      вихідне = вихідне * 10 + (ціле(с) - СИМВОЛ_0);

      п += 1;
    }

  успіх:
    вихід::вміст = вихідне * ціле(знак);
    вернути так;
  }

  зовнішня дія спробувати_розібрати_позитивне_число(компілятор: адреса<Компілятор>, значення: т8, вихід: адреса<п64>, вихід_помилки: адреса<т8>, вихід_позиції_помилки: адреса<позитивне>): логічне {
    змінна вихідне: позитивне = 0;
    змінна п: позитивне = 0;

    поки п < значення.розмір {
      змінна с = значення.дані[п];

      якщо с == СИМВОЛ_0 {
      } інакше якщо с == СИМВОЛ_1 {
      } інакше якщо с == СИМВОЛ_2 {
      } інакше якщо с == СИМВОЛ_3 {
      } інакше якщо с == СИМВОЛ_4 {
      } інакше якщо с == СИМВОЛ_5 {
      } інакше якщо с == СИМВОЛ_6 {
      } інакше якщо с == СИМВОЛ_7 {
      } інакше якщо с == СИМВОЛ_8 {
      } інакше якщо с == СИМВОЛ_9 {
      } інакше {
        стрибнути успіх;
      }

      вихідне = вихідне * 10 + (позитивне(с) - СИМВОЛ_0);

      п += 1;
    }

  успіх:
    вихід::вміст = вихідне;
    вернути так;
  }

  зовнішня дія спробувати_розібрати_дійсне_число(компілятор: адреса<Компілятор>, значення: т8, вихід: адреса<д64>, вихід_помилки: адреса<т8>, вихід_позиції_помилки: адреса<позитивне>): логічне {
    змінна вихідне: д64 = 0.0;
    змінна фрак: д64 = 0.0;
    змінна дів: д64 = 10.0;
    змінна п: позитивне = 0;
    змінна знак: ц8 = 1;
    змінна була_крапка = ні;

    якщо п < значення.розмір {
      змінна с = значення.дані[п];

      якщо с == СИМВОЛ_МІНУС {
        знак = ц8(0)-1;
        п += 1;
      } інакше {
        якщо с == СИМВОЛ_ПЛЮС {
          п += 1;
        }
      }
    }

    поки п < значення.розмір {
      змінна с = значення.дані[п];
      змінна с_крапка = с == СИМВОЛ_КРАПКА;
      змінна с_цбр_0 = с >= СИМВОЛ_0;
      змінна с_цмр_9 = с <= СИМВОЛ_9;
      змінна с_цифра = с_цбр_0 * с_цмр_9;

      змінна вже_була_крапка = була_крапка;

      якщо с_крапка {
        якщо вже_була_крапка {
          стрибнути успіх;
        }

        була_крапка = так;

        п += 1;
      } інакше {
        якщо с_цифра == ні {
          стрибнути успіх;
        }

        якщо вже_була_крапка {
          фрак = фрак + (д64(с) - СИМВОЛ_0) / дів;
          дів = дів * 10.0;
        } інакше {
          вихідне = вихідне * 10.0 + (д64(с) - СИМВОЛ_0);
        }

        п += 1;
      }
    }

  успіх:
    вихід::вміст = д64(знак) * (вихідне + фрак);
    вернути так;
  }

  зовнішня дія перетворити_позитивне_на_т8(компілятор: адреса<Компілятор>, значення: позитивне, вихід: адреса<т8>): логічне {
    змінна довжина: позитивне = 0;
    змінна тимч: позитивне = значення;

    довжина += 1;
    тимч /= 10;

    поки тимч != 0 {
      довжина += 1;
      тимч /= 10;
    }

    змінна значення_т8 = т8 { довжина, виділити_памʼять<п8>(компілятор, довжина) };

    змінна п = ціле(довжина - 1);
    поки п >= 0 {
      значення_т8.дані[п] = п8(СИМВОЛ_0) + п8(значення % 10);
      значення /= 10;
      п -= 1;
    }

    вихід::вміст = значення_т8;

    вернути так;
  }

  зовнішня дія отримати_повну_назву_в_контексті(компілятор: адреса<Компілятор>, контекст: Контекст, назва: т8): т8 {
    змінна накопичувач_т8 = зробити_накопичувач_т8(компілятор);

    покласти_в_накопичувач_т8(компілятор, накопичувач_т8::адреса, назва);

    змінна поточне_середовище = контекст.середовище;

    поки поточне_середовище != пусто {
      якщо поточне_середовище.обʼєкт_секції != пусто {
        якщо поточне_середовище.обʼєкт_секції.назва.значення.розмір > 0 {
          покласти_спереду_накопичувача_т8(компілятор, накопичувач_т8::адреса, "::");
          покласти_спереду_накопичувача_т8(компілятор, накопичувач_т8::адреса, поточне_середовище.обʼєкт_секції.назва.значення);
        }
      } інакше якщо поточне_середовище.обʼєкт_дії != пусто {
        якщо поточне_середовище.обʼєкт_дії.назва.значення.розмір > 0 {
          покласти_спереду_накопичувача_т8(компілятор, накопичувач_т8::адреса, "::");
          покласти_спереду_накопичувача_т8(компілятор, накопичувач_т8::адреса, поточне_середовище.обʼєкт_дії.назва.значення);
        }
      }

      поточне_середовище = поточне_середовище.зовнішнє;
    }

    вернути накопичувач_т8.значення;
  }
}