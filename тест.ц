//взяти визначення друк;

зовнішня дія strcmp(сі1: памʼять<ц8>, сі2: памʼять<ц8>): ціле;

секція ут {
  структура Слово {
    назва: памʼять<ц8>;
  }

  структура Властивість {
    слово: комірка<Слово>;
    значення: комірка<Обʼєкт>;
  }

  структура Обʼєкт {
    наступний_обʼєкт: комірка<Обʼєкт>;
    помарковано: ціле;

    властивості: памʼять<Властивість>;
    кількість_властивостей: ціле;
  }

  структура Утилізатор<М> {
    слова: памʼять<комірка<Слово>>;
    кількість_слів: ціле;

    початок: комірка<Обʼєкт>;
    кількість_обʼєктів: ціле;

    машина: М;
    помаркувати_обʼєкти: комірка<Утилізатор<М>> -> ніщо;
  }

  дія створити_слово(назва: памʼять<ц8>): комірка<Слово> {
    ціль слово = виділити<Слово>(1);
    слово.назва = назва;
    вернути слово;
  }

  дія отримати_або_створити_слово<М>(утилізатор: комірка<Утилізатор<М>>, назва: памʼять<ц8>): комірка<Слово> {
    змінна х = 0;
    поки х < утилізатор.кількість_слів {
      ціль слово = утилізатор.слова[х];
      якщо strcmp(слово.назва, назва) == 0 {
        вернути слово;
      }
      х = х + 1;
    }
    утилізатор.слова = перевиділити<комірка<Слово>>(утилізатор.слова, утилізатор.кількість_слів + 1);
    утилізатор.слова[утилізатор.кількість_слів] = створити_слово(назва);
    утилізатор.кількість_слів = утилізатор.кількість_слів + 1;
    вернути утилізатор.слова[утилізатор.кількість_слів - 1];
  }

  дія створити_утилізатор<М>(машина: М, помаркувати_обʼєкти: комірка<Утилізатор<М>> -> ніщо): комірка<Утилізатор<М>> {
    ціль утилізатор = виділити<Утилізатор<М>>(1);

    утилізатор.слова = пусто;
    утилізатор.кількість_слів = 0;

    утилізатор.початок = пусто;
    утилізатор.кількість_обʼєктів = 0;

    утилізатор.машина = машина;
    утилізатор.помаркувати_обʼєкти = помаркувати_обʼєкти;

    вернути утилізатор;
  }

  дія утилізувати<М>(утилізатор: комірка<Утилізатор<М>>) {
//    утилізатор.помаркувати_обʼєкти(утилізатор);

//    змінна попередній_обʼєкт: комірка<Обʼєкт> = пусто;
//    змінна обʼєкт = утилізатор.початок;
//    поки обʼєкт != пусто {
//      ціль наступний_обʼєкт = обʼєкт.наступний_обʼєкт;
//      якщо обʼєкт.помарковано == 0 {
//        якщо попередній_обʼєкт == пусто {
//          утилізатор.початок = наступний_обʼєкт;
//        } інакше {
//          попередній_обʼєкт.наступний_обʼєкт = наступний_обʼєкт;
//        }
//        звільнити(обʼєкт);
//        утилізатор.кількість_обʼєктів = утилізатор.кількість_обʼєктів - 1;
//      } інакше {
//        попередній_обʼєкт = обʼєкт;
//      }
//      обʼєкт = наступний_обʼєкт;
//    }
//    обʼєкт = утилізатор.початок;
//    поки обʼєкт != пусто {
//      обʼєкт.помарковано = 0;
//      обʼєкт = обʼєкт.наступний_обʼєкт;
//    }
  }

  дія створити_обʼєкт<М>(утилізатор: комірка<Утилізатор<М>>): комірка<Обʼєкт> {
//    утилізувати<М>(утилізатор);
//    ціль обʼєкт = виділити<Обʼєкт>(1);
//    обʼєкт.наступний_обʼєкт = утилізатор.початок;
//    обʼєкт.помарковано = 0;
//    обʼєкт.властивості = пусто;
//    обʼєкт.кількість_властивостей = 0;
//    утилізатор.початок = обʼєкт;
//    утилізатор.кількість_обʼєктів = утилізатор.кількість_обʼєктів + 1;
    вернути обʼєкт;
  }

  дія змінити_властивість_обʼєкта_за_словом(обʼєкт: комірка<Обʼєкт>, слово: комірка<Слово>, значення: комірка<Обʼєкт>) {
    змінна існуюча_властивість: комірка<Властивість> = пусто;
    змінна х = 0;
    поки х < обʼєкт.кількість_властивостей {
      якщо обʼєкт.властивості[х].слово == слово {
        існуюча_властивість = комірка(обʼєкт.властивості[х]);
      }
      х = х + 1;
    }
    якщо існуюча_властивість == пусто {
      обʼєкт.властивості = перевиділити<Властивість>(обʼєкт.властивості, обʼєкт.кількість_властивостей + 1);
      обʼєкт.властивості[обʼєкт.кількість_властивостей].слово = слово;
      обʼєкт.властивості[обʼєкт.кількість_властивостей].значення = значення;
      обʼєкт.кількість_властивостей = обʼєкт.кількість_властивостей + 1;
    } інакше {
      існуюча_властивість.значення = значення;
    }
  }

  дія змінити_властивість_обʼєкта_за_назвою<М>(утилізатор: комірка<Утилізатор<М>>, обʼєкт: комірка<Обʼєкт>, назва: памʼять<ц8>, значення: комірка<Обʼєкт>) {
    ціль слово = отримати_або_створити_слово<М>(утилізатор, назва);
    змінити_властивість_обʼєкта_за_словом(обʼєкт, слово, значення);
  }

  дія помаркувати_обʼєкт(обʼєкт: комірка<ут::Обʼєкт>) {
    обʼєкт.помарковано = 1;
    змінна х = 0;
    поки х < обʼєкт.кількість_властивостей {
      ціль вл = обʼєкт.властивості[х];
      ціль обʼєкт = вл.значення;
      якщо обʼєкт.помарковано == 0 {
        помаркувати_обʼєкт(обʼєкт);
      }
      х = х + 1;
    }
  }
}

секція ма {
  структура Машина {
    утилізатор: комірка<ут::Утилізатор<комірка<ма::Машина>>>;
    стопка: памʼять<комірка<ут::Обʼєкт>>;
    розмір_стопки: ціле;
  }

  дія створити_машину(): комірка<Машина> {
    ціль машина = виділити<Машина>(1);
    машина.стопка = пусто;
    машина.розмір_стопки = 0;
    вернути машина;
  }

  дія покласти_на_стопку(машина: комірка<Машина>, обʼєкт: комірка<ут::Обʼєкт>) {
    машина.стопка = перевиділити<комірка<ут::Обʼєкт>>(машина.стопка, машина.розмір_стопки + 1);
    машина.стопка[машина.розмір_стопки] = обʼєкт;
    машина.розмір_стопки = машина.розмір_стопки + 1;
  }

  дія забрати_зі_стопки(машина: комірка<Машина>): комірка<ут::Обʼєкт> {
    машина.розмір_стопки = машина.розмір_стопки - 1;
    вернути машина.стопка[машина.розмір_стопки];
  }
}

дія помаркувати_обʼєкти(утилізатор: комірка<ут::Утилізатор<комірка<ма::Машина>>>) {
  змінна х = 0;
  поки х < утилізатор.машина.розмір_стопки {
    ціль обʼєкт = утилізатор.машина.стопка[х];
    якщо обʼєкт.помарковано == 0 {
      ут::помаркувати_обʼєкт(обʼєкт);
    }
    х = х + 1;
  }
}

дія старт(): ціле {
  ціль машина = ма::створити_машину();
  ціль утилізатор = ут::створити_утилізатор<комірка<ма::Машина>>(машина, помаркувати_обʼєкти);
  машина.утилізатор = утилізатор;

  ціль супер = ут::створити_обʼєкт<комірка<ма::Машина>>(утилізатор);
//  ма::покласти_на_стопку(машина, супер);
//  ут::змінити_властивість_обʼєкта_за_назвою<комірка<ма::Машина>>(утилізатор, супер, сі"кількість", ут::створити_обʼєкт<комірка<ма::Машина>>(утилізатор));
//  ут::змінити_властивість_обʼєкта_за_назвою<комірка<ма::Машина>>(утилізатор, супер, сі"кількість", ут::створити_обʼєкт<комірка<ма::Машина>>(утилізатор));
//  ут::створити_обʼєкт<комірка<ма::Машина>>(утилізатор);

//  змінна х = 0;
//  поки х != 10000 {
//    ут::створити_обʼєкт<комірка<ма::Машина>>(утилізатор);
//    х = х + 1;
//  }
//
//  ут::утилізувати<комірка<ма::Машина>>(утилізатор);
//
//  друк_ціле(утилізатор.кількість_обʼєктів);
//
//  друк_сі(сі"привіт");

  вернути 0;
}